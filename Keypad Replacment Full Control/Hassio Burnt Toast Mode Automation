- id: hrv_winter_control_no_sonoff
  alias: HRV Winter Control (No Sonoff)
  mode: restart

  # Re-evaluate on sensor changes + every 5 minutes
  trigger:
    - platform: state
      entity_id:
        - sensor.floating_unit_roof_living_temperature   # Roof temp (old sensor)
        - sensor.floating_unit_roof_living_humidity      # Roof humidity (old sensor)
        - sensor.upstairs_bedrooms_temperature           # House temp (old sensor)
        - sensor.upstairs_bedrooms_humidity              # House humidity (old sensor)
    - platform: time_pattern
      minutes: "/5"

  # ðŸ”’ Do nothing while Burnt Toast/Boost is active
  condition:
    - condition: state
      entity_id: binary_sensor.hrv_boost_active
      state: 'off'

  variables:
    # ---- CONTROL ENTITIES (new ESPHome) ----
    fan_power: switch.hrv_power
    fan_speed_number: number.hrv_fan     # change if your entity is different

    # ---- SENSOR ENTITIES (keep your existing ones) ----
    roof_t_entity: sensor.floating_unit_roof_living_temperature
    roof_h_entity: sensor.floating_unit_roof_living_humidity
    house_t_entity: sensor.upstairs_bedrooms_temperature
    house_h_entity: sensor.upstairs_bedrooms_humidity

    # ---- Readings with safe fallbacks ----
    roof_t: "{{ states(roof_t_entity)  | float(10.0) }}"
    roof_h: "{{ states(roof_h_entity)  | float(55.0) }}"
    house_t: "{{ states(house_t_entity) | float(10.0) }}"
    house_h: "{{ states(house_h_entity) | float(55.0) }}"
    dt: "{{ roof_t - house_t }}"                # temp delta (roof - house)
    dh: "{{ roof_h - house_h }}"                # humidity delta (roof - house)

    # ---- Schedules ----
    day_start: "09:00:00"
    eve_start: "16:00:00"
    night_start: "22:00:00"
    is_day: >-
      {{ day_start <= now().strftime('%H:%M:%S') < eve_start }}
    is_eve: >-
      {{ eve_start <= now().strftime('%H:%M:%S') < night_start }}
    is_night: >-
      {{ now().strftime('%H:%M:%S') >= night_start or now().strftime('%H:%M:%S') < day_start }}

    # ---- Tunables ----
    heat_dt_on: 0.5        # start heating if roof â‰¥ house + 0.5Â°C
    heat_dt_max: 4.0       # scale up to this delta
    heat_hum_allow: 3.0    # roof humidity can be up to +3% higher and still heat

    hum_hi: 65.0           # house humidity â€œhighâ€ above this
    hum_adv: -2.0          # roof must be at least 2% DRIER (dh <= -2.0)
    hum_cool_penalty: 0.5  # allow dehumidifying if roof â‰¤ 0.5Â°C cooler

    min_circ: 10           # daytime trickle (%)
    hum_speed: 18          # dehumidify speed
    heat_min: 20           # min speed while heating
    heat_max: 60           # max speed while heating

  action:
    - choose:

        # 1) EVENING HEATING
        - conditions:
            - condition: template
              value_template: "{{ is_eve }}"
            - condition: template
              value_template: "{{ dt >= heat_dt_on }}"
            - condition: template
              value_template: "{{ dh <= heat_hum_allow }}"
          sequence:
            - variables:
                frac: >-
                  {% set f = (dt - heat_dt_on) / (heat_dt_max - heat_dt_on) %}
                  {{ [0, [f, 1] | min] | max }}
                speed: "{{ (heat_min + frac * (heat_max - heat_min)) | round(0) }}"
            - service: switch.turn_on
              target: { entity_id: "{{ fan_power }}" }
            - service: number.set_value
              target: { entity_id: "{{ fan_speed_number }}" }
              data: { value: "{{ speed }}" }

        # 2) DAY HEATING
        - conditions:
            - condition: template
              value_template: "{{ is_day }}"
            - condition: template
              value_template: "{{ dt >= heat_dt_on }}"
            - condition: template
              value_template: "{{ dh <= heat_hum_allow }}"
          sequence:
            - variables:
                frac: >-
                  {% set f = (dt - heat_dt_on) / (heat_dt_max - heat_dt_on) %}
                  {{ [0, [f, 1] | min] | max }}
                speed: "{{ (heat_min + frac * (heat_max - heat_min)) | round(0) }}"
            - service: switch.turn_on
              target: { entity_id: "{{ fan_power }}" }
            - service: number.set_value
              target: { entity_id: "{{ fan_speed_number }}" }
              data: { value: "{{ speed }}" }

        # 3) DEHUMIDIFY
        - conditions:
            - condition: template
              value_template: "{{ house_h >= hum_hi }}"
            - condition: template
              value_template: "{{ dh <= hum_adv }}"
            - condition: template
              value_template: "{{ roof_t + hum_cool_penalty >= house_t }}"
          sequence:
            - service: switch.turn_on
              target: { entity_id: "{{ fan_power }}" }
            - service: number.set_value
              target: { entity_id: "{{ fan_speed_number }}" }
              data: { value: "{{ hum_speed }}" }

        # 4) DAYTIME TRICKLE
        - conditions:
            - condition: template
              value_template: "{{ is_day }}"
          sequence:
            - service: switch.turn_on
              target: { entity_id: "{{ fan_power }}" }
            - service: number.set_value
              target: { entity_id: "{{ fan_speed_number }}" }
              data: { value: "{{ min_circ }}" }

        # 5) NIGHT/OFF
        - conditions:
            - condition: template
              value_template: "{{ is_eve or is_night }}"
          sequence:
            - service: number.set_value
              target: { entity_id: "{{ fan_speed_number }}" }
              data: { value: 0 }
            - service: switch.turn_off
              target: { entity_id: "{{ fan_power }}" }
